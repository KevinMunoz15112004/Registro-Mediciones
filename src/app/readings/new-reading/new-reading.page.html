<ion-header>
  <ion-toolbar color="primary">
    <ion-title>Nueva Lectura</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content class="ion-padding">
  <form [formGroup]="form">
    <!-- Foto del Medidor -->
    <ion-card class="ion-margin-bottom">
      <ion-card-header>
        <ion-card-title>Fotografía del Medidor</ion-card-title>
      </ion-card-header>
      <ion-card-content>
        <ion-img *ngIf="meterPhotoBase64" [src]="meterPhotoBase64" style="max-height: 200px; object-fit: cover;"></ion-img>
        <ion-text *ngIf="!meterPhotoBase64" color="medium">
          <p class="ion-text-center">Sin foto capturada</p>
        </ion-text>
        <ion-button expand="block" color="secondary" (click)="takeMeterPhoto()" [disabled]="isLoading" class="ion-margin-top">
          <ion-icon slot="start" name="camera"></ion-icon>
          Capturar Foto del Medidor
        </ion-button>
      </ion-card-content>
    </ion-card>

    <!-- Foto de la Fachada -->
    <ion-card class="ion-margin-bottom">
      <ion-card-header>
        <ion-card-title>Fotografía de la Fachada</ion-card-title>
      </ion-card-header>
      <ion-card-content>
        <ion-img *ngIf="facadePhotoBase64" [src]="facadePhotoBase64" style="max-height: 200px; object-fit: cover;"></ion-img>
        <ion-text *ngIf="!facadePhotoBase64" color="medium">
          <p class="ion-text-center">Sin foto capturada</p>
        </ion-text>
        <ion-button expand="block" color="secondary" (click)="takeFacadePhoto()" [disabled]="isLoading" class="ion-margin-top">
          <ion-icon slot="start" name="camera"></ion-icon>
          Capturar Foto de la Fachada
        </ion-button>
      </ion-card-content>
    </ion-card>

    <!-- Ubicación GPS -->
    <ion-card class="ion-margin-bottom">
      <ion-card-header>
        <ion-card-title>Ubicación GPS</ion-card-title>
      </ion-card-header>
      <ion-card-content>
        <ion-text *ngIf="!currentLocation" color="medium">
          <p class="ion-text-center">Ubicación no obtenida</p>
        </ion-text>
        <ion-text *ngIf="currentLocation">
          <p><strong>Latitud:</strong> {{ currentLocation.latitude }}</p>
          <p><strong>Longitud:</strong> {{ currentLocation.longitude }}</p>
        </ion-text>
        <ion-button expand="block" color="secondary" (click)="getCurrentLocation()" [disabled]="isLoading" class="ion-margin-top">
          <ion-icon slot="start" name="location"></ion-icon>
          Obtener Ubicación
        </ion-button>
        <ion-button *ngIf="mapsLink" expand="block" fill="outline" (click)="window.open(mapsLink, '_blank')" class="ion-margin-top">
          Ver en Google Maps
        </ion-button>
      </ion-card-content>
    </ion-card>

    <!-- Valor del Medidor -->
    <ion-card class="ion-margin-bottom">
      <ion-card-header>
        <ion-card-title>Datos de la Lectura</ion-card-title>
      </ion-card-header>
      <ion-card-content>
        <ion-input
          formControlName="meterValue"
          label="Valor del Medidor (m³)"
          labelPlacement="stacked"
          type="number"
          placeholder="0.00"
          step="0.01"
          class="ion-margin-bottom"
        ></ion-input>
        <ion-text color="danger" *ngIf="meterValue?.invalid && meterValue?.touched">
          <p class="ion-padding-start">Ingresa un valor numérico válido</p>
        </ion-text>

        <ion-input
          formControlName="zone"
          label="Zona (Opcional)"
          labelPlacement="stacked"
          type="text"
          placeholder="Ej: Centro Histórico, Norte"
          class="ion-margin-bottom"
        ></ion-input>

        <ion-input
          formControlName="observations"
          label="Observaciones Adicionales"
          labelPlacement="stacked"
          type="text"
          placeholder="Algún comentario sobre la lectura"
          class="ion-margin-bottom"
        ></ion-input>
      </ion-card-content>
    </ion-card>

    <!-- Botón Enviar -->
    <ion-button
      expand="block"
      color="primary"
      size="large"
      (click)="submitReading()"
      [disabled]="form.invalid || isLoading || !meterPhotoBase64 || !facadePhotoBase64 || !currentLocation"
      class="ion-margin-bottom"
    >
      <ion-spinner *ngIf="isLoading" name="crescent"></ion-spinner>
      Guardar Lectura
    </ion-button>
  </form>
</ion-content>
